name: Content Board (Nightly Digest)

on:
  workflow_dispatch:
  # DST-safe scheduling:
  # - 7pm PT is 03:00 UTC during PST (winter)
  # - 7pm PT is 02:00 UTC during PDT (summer)
  # Run every 10 minutes during BOTH hours; digest.py guard posts only once.
  schedule:
    - cron: "*/10 2,3 * * *"

jobs:
  post_digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests

      # -------------------------
      # AUTO: Latest YouTube upload (scrape /videos + oEmbed for title)
      # -------------------------
      - name: Resolve latest YouTube video (scrape)
        env:
          YT_VIDEOS_URL: "https://www.youtube.com/@smitty-2447/videos"
          USER_AGENT: "Mozilla/5.0 (compatible; IttyBittyGamingNewsBot/1.0)"
        run: |
          python - << 'PY'
          import os, re, sys
          import requests

          videos_url = os.getenv("YT_VIDEOS_URL", "").strip()
          ua = os.getenv("USER_AGENT", "IttyBittyGamingNewsBot/1.0").strip()
          headers = {"User-Agent": ua, "Accept-Language": "en-US,en;q=0.9"}

          if not videos_url:
              print("[YT] Missing YT_VIDEOS_URL", file=sys.stderr)
              sys.exit(0)

          try:
              r = requests.get(videos_url, headers=headers, timeout=25)
              r.raise_for_status()
              html = r.text
          except Exception as e:
              print(f"[YT] Failed to fetch videos page: {e}", file=sys.stderr)
              sys.exit(0)

          m = re.search(r'"videoId"\s*:\s*"([A-Za-z0-9_-]{11})"', html)
          if not m:
              print("[YT] Could not find videoId in /videos HTML. Skipping YouTube auto.", file=sys.stderr)
              sys.exit(0)

          video_id = m.group(1)
          watch_url = f"https://www.youtube.com/watch?v={video_id}"

          title = ""
          try:
              oembed = requests.get(
                  "https://www.youtube.com/oembed",
                  params={"url": watch_url, "format": "json"},
                  headers=headers,
                  timeout=20,
              )
              oembed.raise_for_status()
              title = (oembed.json().get("title") or "").strip()
          except Exception as e:
              print(f"[YT] oEmbed failed (title may be blank): {e}", file=sys.stderr)

          env_path = os.getenv("GITHUB_ENV")
          if not env_path:
              print("[YT] Missing GITHUB_ENV (unexpected).", file=sys.stderr)
              sys.exit(0)

          safe_title = title.replace("\n", " ").replace("\r", " ").strip()

          with open(env_path, "a", encoding="utf-8") as f:
              f.write(f"YOUTUBE_FEATURED_URL={watch_url}\n")
              f.write(f"YOUTUBE_FEATURED_TITLE={safe_title}\n")

          print(f"[YT] latest_url={watch_url}")
          print(f"[YT] latest_title={title}")
          PY

      # -------------------------
      # AUTO: Latest Adilo upload (scrape public latest page)
      #
      # IMPORTANT:
      # - We HARD FAIL if we can’t extract a watch id.
      # - That prevents posting the home hub.
      # -------------------------
      - name: Resolve latest Adilo video (scrape + fail if missing)
        env:
          ADILO_LATEST_URL: "https://adilo.bigcommand.com/c/ittybittygamingnews/video"
          USER_AGENT: "Mozilla/5.0 (compatible; IttyBittyGamingNewsBot/1.0)"
        run: |
          python - << 'PY'
          import os, re, sys
          import requests

          latest_url = os.getenv("ADILO_LATEST_URL", "").strip()
          ua = os.getenv("USER_AGENT", "IttyBittyGamingNewsBot/1.0").strip()

          headers = {
              "User-Agent": ua,
              "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
              "Accept-Language": "en-US,en;q=0.9",
              "Cache-Control": "no-cache",
              "Pragma": "no-cache",
              "Referer": "https://adilo.bigcommand.com/",
          }

          if not latest_url:
              print("[ADILO] Missing ADILO_LATEST_URL", file=sys.stderr)
              sys.exit(1)

          try:
              r = requests.get(latest_url, headers=headers, timeout=30)
              r.raise_for_status()
              html = r.text
          except Exception as e:
              print(f"[ADILO] Failed to fetch latest page: {e}", file=sys.stderr)
              sys.exit(1)

          # Aggressive patterns (Adilo pages sometimes escape / as \/ inside JS blobs)
          patterns = [
              r'adilo\.bigcommand\.com/watch/([A-Za-z0-9_-]+)',
              r'["\']\/watch\/([A-Za-z0-9_-]+)["\']',
              r'\\\/watch\\\/([A-Za-z0-9_-]+)',
              r'watch\/([A-Za-z0-9_-]+)',  # last resort, catches plain watch/ID
              r'video\?id=([A-Za-z0-9_-]+)',
              r'video\?id\\u003d([A-Za-z0-9_-]+)',  # sometimes = is escaped
              r'["\']watchId["\']\s*:\s*["\']([A-Za-z0-9_-]+)["\']',
              r'["\']id["\']\s*:\s*["\']([A-Za-z0-9_-]+)["\']',
          ]

          watch_id = None
          for pat in patterns:
              m = re.search(pat, html)
              if m:
                  watch_id = m.group(1)
                  break

          # Sanity: ignore obviously wrong short IDs
          if watch_id and len(watch_id) < 6:
              watch_id = None

          if not watch_id:
              snippet = html[:800].replace("\n", " ").replace("\r", " ")
              print("[ADILO] Could not extract latest watch id from HTML.", file=sys.stderr)
              print(f"[ADILO] Page status={r.status_code} url={latest_url}", file=sys.stderr)
              print(f"[ADILO] HTML snippet={snippet}", file=sys.stderr)
              sys.exit(1)

          watch_url = f"https://adilo.bigcommand.com/watch/{watch_id}"

          env_path = os.getenv("GITHUB_ENV")
          if not env_path:
              print("[ADILO] Missing GITHUB_ENV (unexpected).", file=sys.stderr)
              sys.exit(1)

          with open(env_path, "a", encoding="utf-8") as f:
              f.write(f"FEATURED_VIDEO_FORCE_ID={watch_id}\n")

          print(f"[ADILO] extracted_watch_id={watch_id}")
          print(f"[ADILO] watch_url={watch_url}")
          PY

      - name: Run digest
        env:
          # Discord webhook for the forward-facing "content board" channel
          DISCORD_WEBHOOK_URL: ${{ secrets.CONTENT_BOARD_WEBHOOK_URL }}

          # Digest behavior
          DIGEST_WINDOW_HOURS: "24"
          DIGEST_TOP_N: "5"
          DIGEST_MAX_PER_SOURCE: "1"

          # Time guard (7pm PT) + DST handling
          DIGEST_GUARD_TZ: "America/Los_Angeles"
          DIGEST_GUARD_LOCAL_HOUR: "19"
          DIGEST_GUARD_WINDOW_MINUTES: "15"

          # Branding
          NEWSLETTER_NAME: "Itty Bitty Gaming News"
          NEWSLETTER_TAGLINE: "Snackable daily gaming news — five days a week."

          # Featured video section labels
          FEATURED_VIDEO_TITLE: "Watch today’s Itty Bitty Gaming News"
          FEATURED_VIDEO_FALLBACK_URL: "https://adilo.bigcommand.com/c/ittybittygamingnews/home"

          # FORCE Adilo newest (scraped)
          FEATURED_VIDEO_FORCE_ID: ${{ env.FEATURED_VIDEO_FORCE_ID }}

          # Adilo API (keep)
          ADILO_PUBLIC_KEY: ${{ secrets.ADILO_PUBLIC_KEY }}
          ADILO_SECRET_KEY: ${{ secrets.ADILO_SECRET_KEY }}
          ADILO_PROJECT_ID: "yz8kq5M8"

          ADILO_PUBLIC_LATEST_PAGE: "https://adilo.bigcommand.com/c/ittybittygamingnews/video"
          ADILO_PUBLIC_HOME_PAGE: "https://adilo.bigcommand.com/c/ittybittygamingnews/home"

          # YouTube (scraped)
          YOUTUBE_FEATURED_URL: ${{ env.YOUTUBE_FEATURED_URL }}
          YOUTUBE_FEATURED_TITLE: ${{ env.YOUTUBE_FEATURED_TITLE }}

          USER_AGENT: "IttyBittyGamingNews/Digest"

        run: |
          python digest.py
