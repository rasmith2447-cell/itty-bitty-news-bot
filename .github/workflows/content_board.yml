name: Itty Bitty Gaming News - Bot + Digest

on:
  workflow_dispatch:
  schedule:
    # Runs frequently; digest.py has its own 7pm guard so it only posts at the right time.
    - cron: "*/30 * * * *"

jobs:
  bot_and_digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # =========================
      # RAW STORIES -> Gaming Blerbs
      # =========================
      - name: Run RAW bot (posts to Gaming Blerbs)
        env:
          # ✅ Gaming Blerbs webhook (raw stories)
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

          USER_AGENT: "IttyBittyGamingNews/Bot"
          MODE: "RAW"
          BREAKING_MODE: "False"
        run: |
          python main.py

      # =========================
      # DIGEST -> Gaming News
      # =========================
      - name: Run DIGEST (posts to Gaming News)
        env:
          # ✅ Gaming News webhook (digest/newsletter)
          DISCORD_WEBHOOK_URL: ${{ secrets.DIGEST_WEBHOOK_URL }}

          # Allow manual runs to post immediately (otherwise guard controls posting)
          DIGEST_FORCE_POST: ${{ github.event_name == 'workflow_dispatch' && 'true' || '' }}

          DIGEST_WINDOW_HOURS: "24"
          DIGEST_TOP_N: "5"
          DIGEST_MAX_PER_SOURCE: "1"

          DIGEST_GUARD_TZ: "America/Los_Angeles"
          DIGEST_GUARD_LOCAL_HOUR: "19"
          DIGEST_GUARD_LOCAL_MINUTE: "0"
          DIGEST_GUARD_WINDOW_MINUTES: "120"

          NEWSLETTER_NAME: "Itty Bitty Gaming News"
          NEWSLETTER_TAGLINE: "Snackable daily gaming news — five days a week."
          USER_AGENT: "IttyBittyGamingNews/Digest"

          # Featured video controls (your existing setup)
          FEATURED_VIDEO_FORCE_ID: ${{ vars.FEATURED_VIDEO_FORCE_ID }}
          YOUTUBE_FEATURED_URL: ${{ vars.YOUTUBE_FEATURED_URL }}
          YOUTUBE_FEATURED_TITLE: ${{ vars.YOUTUBE_FEATURED_TITLE }}

          # Optional override if you are using it
          FEED_URLS: ${{ vars.FEED_URLS }}
        run: |
          python digest.py
