name: Itty Bitty Gaming News - Bot + Digest

on:
  workflow_dispatch:
  schedule:
    # Run frequently; each script decides what to do.
    # - main.py will post new items when found
    # - digest.py will only post once per local day near 7pm PT (guarded)
    - cron: "*/30 * * * *"

jobs:
  news_bot:
    name: News Pull + Content Board
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            requests \
            beautifulsoup4 \
            lxml \
            rapidfuzz \
            feedparser

      - name: Run news bot (main.py)
        env:
          # Webhooks (secrets)
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CONTENT_BOARD_WEBHOOK_URL: ${{ secrets.CONTENT_BOARD_WEBHOOK_URL }}

          # General
          USER_AGENT: "IttyBittyGamingNews/Bot"

          # Optional: your bot modes if you use them
          MODE: "RAW"
          BREAKING_MODE: "False"

        run: |
          python main.py

      # OPTIONAL: If your bot needs to commit state.json updates, keep your existing git commit step here.
      # If you already have a commit step in your current workflow, copy it below this comment and keep it as-is.

  digest:
    name: Evening Digest Newsletter
    runs-on: ubuntu-latest
    needs: news_bot

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml python-dateutil

      - name: Run digest (digest.py)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

          # Digest settings
          DIGEST_WINDOW_HOURS: "24"
          DIGEST_TOP_N: "5"
          DIGEST_MAX_PER_SOURCE: "1"

          # Guard settings (DST-safe)
          DIGEST_GUARD_TZ: "America/Los_Angeles"
          DIGEST_GUARD_LOCAL_HOUR: "19"
          DIGEST_GUARD_LOCAL_MINUTE: "0"
          DIGEST_GUARD_WINDOW_MINUTES: "120"

          # Branding
          NEWSLETTER_NAME: "Itty Bitty Gaming News"
          NEWSLETTER_TAGLINE: "Snackable daily gaming news — five days a week."
          USER_AGENT: "IttyBittyGamingNews/Digest"

          # Adilo
          ADILO_PUBLIC_LATEST_PAGE: "https://adilo.bigcommand.com/c/ittybittygamingnews/video"
          ADILO_PUBLIC_HOME_PAGE: "https://adilo.bigcommand.com/c/ittybittygamingnews/home"
          FEATURED_VIDEO_FALLBACK_URL: "https://adilo.bigcommand.com/c/ittybittygamingnews/home"
          FEATURED_VIDEO_TITLE: "Watch today’s Itty Bitty Gaming News"
          FEATURED_VIDEO_FORCE_ID: ${{ vars.FEATURED_VIDEO_FORCE_ID }}

          # YouTube (auto if your content_board step sets these repo vars; otherwise optional)
          YOUTUBE_FEATURED_URL: ${{ vars.YOUTUBE_FEATURED_URL }}
          YOUTUBE_FEATURED_TITLE: ${{ vars.YOUTUBE_FEATURED_TITLE }}

          # Optional: override feeds via repo variable (one URL per line)
          FEED_URLS: ${{ vars.FEED_URLS }}

        run: |
          python digest.py
