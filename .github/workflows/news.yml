name: Itty Bitty Gaming News Bot (3x Daily Pulls)

on:
  workflow_dispatch:
  schedule:
    # 7:00am PT -> 14:00 UTC (PDT) or 15:00 UTC (PST)
    - cron: "0 14 * * *"
    - cron: "0 15 * * *"

    # 1:00pm PT -> 20:00 UTC (PDT) or 21:00 UTC (PST)
    - cron: "0 20 * * *"
    - cron: "0 21 * * *"

    # 6:00pm PT -> 01:00 UTC (PDT) or 02:00 UTC (PST)
    - cron: "0 1 * * *"
    - cron: "0 2 * * *"

jobs:
  pull_and_post:
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      MODE: RAW
      BREAKING_MODE: "False"
      USER_AGENT: IttyBittyGamingNews/NewsPull

      # DST guard configuration
      GUARD_TZ: America/Los_Angeles
      GUARD_WINDOW_MINUTES: "15"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Guard (DST-safe, schedule only)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          python - <<'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo
          import os, sys

          tz = os.getenv("GUARD_TZ", "America/Los_Angeles")
          window = int(os.getenv("GUARD_WINDOW_MINUTES", "15"))

          now = datetime.now(ZoneInfo(tz))
          hh = now.strftime("%H")
          mm = int(now.strftime("%M"))

          print(f"[GUARD] Local time in {tz}: {now.strftime('%Y-%m-%d %H:%M:%S %Z')}")

          if mm >= window:
              print("[GUARD] Outside minute window. Exiting without posting.")
              sys.exit(0)

          if hh not in ("07", "13", "18"):
              print("[GUARD] Not a target hour (07/13/18). Exiting without posting.")
              sys.exit(0)

          print("[GUARD] Passed. Continuing.")
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests beautifulsoup4 python-dateutil rapidfuzz

      - name: Run main bot
        run: |
          python main.py
